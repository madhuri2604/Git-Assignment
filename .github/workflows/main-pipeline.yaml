name: Main Terraform WIF Workflow

on:
  push:
    branches: [main]

jobs:

  auth:
    uses: ./.github/workflows/auth.yaml@main
    permissions:
      id-token: write
      contents: read
    with:
      workload_identity_provider: 'projects/349782046408/locations/global/workloadIdentityPools/github-demo-pool/providers/github-identity-provider'
      service_account: 'sa-workload-identity-fed@prj-gcp-inframod-01.iam.gserviceaccount.com'
      project_id: 'prj-gcp-inframod-01'
    outputs:
      credentials_file_path: ${{ steps.auth.outputs.credentials_file_path }}

  terraform:
    needs: auth
    uses: ./.github/workflows/terraform.yaml@main
    with:
      resource_name: 'gcs'
      region: 'usc1'
      terraform_version: '1.8.5'
    secrets: inherit
    env:
      GOOGLE_APPLICATION_CREDENTIALS: ${{ needs.call-auth.outputs.credentials_file_path }}
