name: GCP WIF + Terraform GCS Pipeline
env:
  RESOURCE_NAME: "gcs"
  REGION:  "usc1"
  TERRAFORM_VERSION: "1.8.5"   
on:
  push:
    branches: [main]

jobs:
  auth-jb:
    runs-on: ubuntu-latest
    outputs:
      credentials_file_path: ${{ steps.auth.outputs.credentials_file_path }}
      output1: $
    permissions:
      contents: read
      id-token: write

    steps:


    - name: Authenticate to GCP via WIF
      id: auth 
      uses: google-github-actions/auth@v2
      with:
        create_credentials_file : true
        workload_identity_provider: 'projects/349782046408/locations/global/workloadIdentityPools/github-demo-pool/providers/github-identity-provider'
        service_account: 'sa-workload-identity-fed@prj-gcp-inframod-01.iam.gserviceaccount.com' 

    # - name: Debug output
    #   run: echo "Credentials file path: ${{ steps.auth.outputs.credentials_file_path }}"

    - name: Base64 encode the credentials file
      id: encode-creds
      run: |
        echo "credentials_json_b64=$(base64 ${{ steps.auth.outputs.credentials_file_path }} | tr -d '\n')" >> $GITHUB_OUTPUT

  terraform-jb
    needs: auth-jb
    runs-on: ubuntu-latest
    steps:
    - env:
        OUTPUT1: $
      run echo "$OUTPUT1"

    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Decode credentials
      run: |
        echo "${{ inputs.credentials_json_b64 }}" | tr -d '\n' | base64 -d > "$HOME/adc.json"
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/adc.json" >> $GITHUB_ENV

    - name: Verify credentials
      run: cat $HOME/adc.json | jq .

    # - name: Setup Terraform
    #   uses: hashicorp/setup-terraform@v3
    #   with:
    #     terraform_version:  ${{env.TERRAFORM_VERSION}}

    # - name: Terraform Init
    #   run: |
    #     terraform init -backend-config=${{ github.workspace }}/Modules/${RESOURCE_NAME}/config/backend/${REGION}/backend.auto.tfvars
    #   working-directory: Modules/${{ env.RESOURCE_NAME }}/config

    # - name: Terraform Plan
    #   run: |
    #     terraform plan -var-file=${{ github.workspace }}/Modules/${RESOURCE_NAME}/${REGION}/terraform.tfvars -out=tfplan
    #   working-directory: Modules/${{ env.RESOURCE_NAME }}/config

